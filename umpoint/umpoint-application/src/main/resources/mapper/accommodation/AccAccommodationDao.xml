<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="my.edu.um.umpoint.modules.accommodation.dao.AccAccommodationDao">

    <resultMap type="my.edu.um.umpoint.modules.accommodation.entity.AccAccommodationEntity" id="accAccommodationMap">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="catId" column="cat_id"/>
        <result property="deptId" column="dept_id"/>
        <result property="address" column="address"/>
        <result property="description" column="description"/>
        <result property="facilities" column="facilities"/>
        <result property="capacity" column="capacity"/>
        <result property="manager" column="manager"/>
        <result property="bookingRuleId" column="booking_rule_id"/>
        <result property="status" column="status"/>
        <result property="creator" column="creator"/>
        <result property="createDate" column="create_date"/>
        <result property="updater" column="updater"/>
        <result property="updateDate" column="update_date"/>
    </resultMap>

    <resultMap type="my.edu.um.umpoint.modules.accommodation.entity.AccAccommodationEntity" id="accAccommodationSelectMap">
        <id property="id" column="id"/>
        <result property="name" column="name"/>
        <result property="catId" column="cat_id"/>
        <result property="deptId" column="dept_id"/>
        <result property="address" column="address"/>
        <result property="description" column="description"/>
        <result property="facilities" column="facilities"/>
        <result property="capacity" column="capacity"/>
        <result property="manager" column="manager"/>
        <result property="bookingRuleId" column="booking_rule_id"/>
        <result property="status" column="status"/>
        <result property="creator" column="creator"/>
        <result property="createDate" column="create_date"/>
        <result property="updater" column="updater"/>
        <result property="updateDate" column="update_date"/>
        <result column="category" property="category" />
        <result column="dept_name" property="deptName" />
        <result column="manager_name" property="managerName" />
        <result column="creator_name" property="creatorName" />
        <result column="updater_name" property="updaterName" />
        <association property="accBookingRuleEntity">
            <id property="id" column="booking_rule_id"/>
            <result property="dayPrice" column="day_price"/>
            <result property="weekPrice" column="week_price"/>
            <result property="dayPrice" column="day_price"/>
            <result property="openDaysBeforeEvent" column="open_days_before_event"/>
            <result property="closeDaysBeforeEvent" column="close_days_before_event"/>
            <result property="maxReservationDays" column="max_reservation_days"/>
            <result property="approvalRequired" column="approval_required"/>
            <result property="minBookingDays" column="min_booking_days"/>
        </association>
        <collection property="accImageEntityList" ofType="my.edu.um.umpoint.modules.accommodation.entity.AccImageEntity">
            <id property="id" column="image_id"/>
            <result property="accommodationId" column="image_accommodation_id"/>
            <result property="imageUrl" column="image_url"/>
        </collection>
        <collection property="accTagEntityList" ofType="my.edu.um.umpoint.modules.accommodation.entity.AccTagEntity">
            <id property="id" column="tag_id"/>
            <result column="tag_name" property="tagName"/>
        </collection>
    </resultMap>

    <select id="getList" resultMap="accAccommodationSelectMap">
        SELECT
        a.id,
        a.name,
        a.cat_id,
        a.dept_id,
        a.address,
        a.description,
        a.facilities,
        a.capacity,
        a.manager,
        a.booking_rule_id,
        a.creator,
        a.create_date,
        a.updater,
        a.update_date,
        c.name AS category,
        d.name AS dept_name,
        m.username AS manager_name,
        cr.username AS creator_name,
        u.username AS updater_name,
        b.id AS booking_rule_id,
        b.day_price,
        b.week_price,
        b.open_days_before_event,
        b.close_days_before_event,
        b.max_reservation_days,
        b.approval_required,
        b.min_booking_days,
        i.id AS image_id,
        i.accommodation_id AS image_accommodation_id,
        i.image_url,
        t.id AS tag_id,
        t.tag_name
        FROM acc_accommodation a
        LEFT JOIN acc_category c ON a.cat_id = c.id
        LEFT JOIN sys_dept d ON a.dept_id = d.id
        LEFT JOIN acc_image i ON a.id = i.accommodation_id
        LEFT JOIN acc_booking_rule b ON a.booking_rule_id = b.id
        LEFT JOIN acc_accommodation_tag at ON a.id = at.accommodation_id
        LEFT JOIN acc_tag t ON at.tag_id = t.id
        LEFT JOIN sys_user m ON a.manager = m.id
        LEFT JOIN sys_user cr ON a.creator = cr.id
        LEFT JOIN sys_user u ON a.updater = u.id
        <where>
            and a.status = 1
            <if test="name != null and name.trim() != ''">
                and a.name like #{name}
            </if>
            <if test="catId != null">
                AND a.cat_id = #{catId}
            </if>
            <if test="tagId != null">
                AND at.tag_id = #{tagId}
            </if>
            <if test="deptIdList != null">
                AND a.dept_id IN
                <foreach item="id" collection="deptIdList" open="(" separator="," close=")">
                    #{id}
                </foreach>
            </if>
        </where>
    </select>
    <select id="selectById" resultMap="accAccommodationSelectMap">
        SELECT
        a.id,
        a.name,
        a.cat_id,
        a.dept_id,
        a.address,
        a.description,
        a.facilities,
        a.capacity,
        a.manager,
        a.booking_rule_id,
        a.creator,
        a.create_date,
        a.updater,
        a.update_date,
        c.name AS category,
        d.name AS dept_name,
        m.username AS manager_name,
        cr.username AS creator_name,
        u.username AS updater_name,
        b.id AS booking_rule_id,
        b.day_price,
        b.week_price,
        b.open_days_before_event,
        b.close_days_before_event,
        b.max_reservation_days,
        b.approval_required,
        b.min_booking_days,
        i.id AS image_id,
        i.image_url,
        t.id AS tag_id,
        t.tag_name
        FROM acc_accommodation a
        LEFT JOIN acc_category c ON a.cat_id = c.id
        LEFT JOIN sys_dept d ON a.dept_id = d.id
        LEFT JOIN acc_image i ON a.id = i.accommodation_id
        LEFT JOIN acc_booking_rule b ON a.booking_rule_id = b.id
        LEFT JOIN acc_accommodation_tag at ON a.id = at.accommodation_id
        LEFT JOIN acc_tag t ON at.tag_id = t.id
        LEFT JOIN sys_user m ON a.manager = m.id
        LEFT JOIN sys_user cr ON a.creator = cr.id
        LEFT JOIN sys_user u ON a.updater = u.id
        WHERE a.id = #{id}
    </select>
</mapper>